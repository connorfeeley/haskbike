:PROPERTIES:
:header-args: sql
:END:
#+title: README
#+author: Connor Feeley
#+date: 2023-09-10
#+PROPERTY: header-args:sql+ :engine postgres :database haskbike
* Tasks
** TODO Add function to ~Operations~ to query and order by ~last_reported~
#+name: joined-stations
#+begin_src sql
select
       station_information.name,
       station_status.*
from station_status
inner join station_information
on station_status.station_id = station_information.station_id
order by last_reported asc;
#+end_src

#+begin_src sql
select
       station_information.name,
       station_status.*
from station_status
inner join station_information
on station_status.station_id = station_information.station_id
order by last_reported asc
limit 6;
#+end_src

#+RESULTS:
| name                             |  id | station_id | num_bikes_available | num_bikes_disabled | num_docks_available | num_docks_disabled | last_reported       | is_charging_station | status     | is_installed | is_renting | is_returning | traffic | vehicle_docks_available | vehicle_types_available_boost | vehicle_types_available_iconic | vehicle_types_available_efit | vehicle_types_available_efit_g5 |
|----------------------------------+-----+------------+---------------------+--------------------+---------------------+--------------------+---------------------+---------------------+------------+--------------+------------+--------------+---------+-------------------------+-------------------------------+--------------------------------+------------------------------+---------------------------------|
| St. Joseph St / Bay St - SMART   | 459 |       7548 |                  11 |                  0 |                   8 |                  0 | 2023-09-12 18:27:45 | f                   | IN_SERVICE | t            | t          | t            |         |                       8 |                             0 |                             10 |                            0 |                               1 |
| Beverley St / College St         | 148 |       7161 |                   6 |                  0 |                  17 |                  0 | 2023-09-12 18:55:03 | f                   | IN_SERVICE | t            | t          | t            |         |                      17 |                             0 |                              6 |                            0 |                               0 |
| Gerrard St E / Leslie St         | 366 |       7431 |                  20 |                  0 |                   5 |                  0 | 2023-09-12 19:02:56 | f                   | IN_SERVICE | t            | t          | t            |         |                       5 |                             0 |                             20 |                            0 |                               0 |
| Lake Shore Blvd E / Knox Ave     | 274 |       7319 |                   9 |                  0 |                   2 |                  0 | 2023-09-12 19:03:13 | f                   | IN_SERVICE | t            | t          | t            |         |                       2 |                             0 |                              8 |                            0 |                               1 |
| Rosehill Ave / Avoca Ave - SMART | 245 |       7279 |                   0 |                  0 |                  16 |                  0 | 2023-09-12 19:03:51 | f                   | IN_SERVICE | t            | t          | t            |         |                      16 |                             0 |                              0 |                            0 |                               0 |
| Widmer St / King St W            | 609 |       7721 |                   4 |                  0 |                   7 |                  0 | 2023-09-12 19:03:51 | f                   | IN_SERVICE | t            | t          | t            |         |                       7 |                             0 |                              4 |                            0 |                               0 |

** TODO View

#+name: select-view
#+begin_src sql :noeval
station_information.name,
station_status.id, station_status.station_id,
num_bikes_available, num_bikes_disabled, num_docks_available, num_docks_disabled,
last_reported, station_status.is_charging_station, status,
is_installed, is_renting, is_returning,
-- traffic, vehicle_docks_available,
vehicle_types_available_boost, vehicle_types_available_iconic, vehicle_types_available_efit, vehicle_types_available_efit_g5
#+end_src

#+name: columns-view
#+begin_src sql :noeval
name,
id, s_id,
"#bk_avl", "#bk_dis", "#dk_avl", "#d_dis",
"last_reported", "chrg", "status",
"inst", "rent", "retr",
-- "traf", "d_a",
"boost", "iconic", "efit", "efit_5g"

#+end_src

Create view:
#+begin_src sql :results none
DROP VIEW IF EXISTS station_view;
CREATE VIEW station_view (
        <<columns-view>>
)
AS
        SELECT
                <<select-view>>
        FROM station_status
        INNER JOIN station_information
        ON station_status.station_id = station_information.station_id
        ;
#+end_src

Create view:
#+begin_src sql
SELECT *
FROM
        station_view
WHERE
        -- chrg = TRUE
        name LIKE 'Wellesley Station Green P'
        -- "#d_a" != "d_a"
ORDER BY last_reported ASC
;
#+end_src

#+RESULTS:
| name                      | id | s_id | #bk_avl | #bk_dis | #dk_avl | #d_dis | last_reported       | chrg | status     | inst | rent | retr | boost | iconic | efit | efit_5g |
|---------------------------+----+------+---------+---------+---------+--------+---------------------+------+------------+------+------+------+-------+--------+------+---------|
| Wellesley Station Green P |  2 | 7001 |       7 |      13 |       3 |      0 | 2023-09-12 19:02:28 | t    | IN_SERVICE | t    | t    | t    |     0 |      7 |    0 |       0 |
* Views

Create view:
#+begin_src sql :results none
DROP VIEW IF EXISTS station_view;
CREATE VIEW station_view (
        <<columns-view>>
)
AS
        SELECT
                <<select-view>>
        FROM station_status
        INNER JOIN station_information
        ON station_status.station_id = station_information.station_id
        WHERE (vehicle_types_available_boost + vehicle_types_available_iconic + vehicle_types_available_efit + vehicle_types_available_efit_g5 != num_bikes_available)
        ;
#+end_src


* Useful Commands
** Run Tests (Showing all Output)

#+begin_src shell :noeval
cabal test --test-show-details=direct
#+end_src

** Update Dependencies

#+begin_src shell :noeval
cabal freeze --enable-tests --upgrade-dependencies --allow-newer=aeson
#+end_src

** Query Database

#+begin_src shell :noeval
psql -d haskbike -c "SELECT * FROM station_information"
#+end_src

** Create Database

#+begin_src shell :noeval
createdb haskbike
#+end_src
